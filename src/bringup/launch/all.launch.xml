<launch>
  <arg name="simulation" default="false"/>

  <node unless="$(var simulation)" pkg="can_bridge" exec="can_bridge">
    <param from="$(find-pkg-share bringup)/config/can_bridge.yaml" />
  </node>

  <node pkg="pfloc" exec="pfloc" />

  <node pkg="emcl2" exec="emcl2_node">
    <param name="sensor_reset" value="false" />
    <param name="num_particles" value="50" />
    <param name="range_threshold" value="0.05" />
    <param name="laser_likelihood_max_dist" value="0.2"/>
    <param name="alpha_threshold" value="0.2" />
    <param name="odom_fw_dev_per_fw" value="0.01" />
    <param name="odom_fw_dev_per_rot" value="0.001" />
    <param name="odom_rot_dev_per_fw" value="0.01" />
    <param name="odom_rot_dev_per_rot" value="0.01" />
    <param name="initial_pose_x" value="-0.5" />
    <param name="initial_pose_y" value="0.5" />
    <param name="initial_pose_a" value="0.0" />
  </node>

  <node pkg="nav2_map_server" exec="map_server">
    <param name="yaml_filename" value="$(find-pkg-share bringup)/map/map.yaml" />
  </node>

  <node pkg="nav2_lifecycle_manager" exec="lifecycle_manager" name="lifecycle_manager">
    <param name="node_names" value="['map_server']" />
    <param name="autostart" value="true" />
  </node>

  <node pkg="laserscan_marger" exec="laserscan_marger_node" >
    <param name="scan_input_topics" value="[scan0, scan1, scan2]"/>
    <param name="out_points" value="2000"/>
    <param name="publish_frequency" value="10.0"/>
    <remap from="scan_out" to="scan"/>
    <param name="out_range_min" value="0.5" />
  </node>

  <node pkg="robot_state_publisher" exec="robot_state_publisher">
    <param name='robot_description' value="$(command 'xacro $(find-pkg-share bringup)/urdf/robot.urdf.xacro')"/>
    <param name="publish_frequency" value="100.0" />
    <param name="ignore_timestamp" value="true" />
  </node>

  <node pkg="udp_multicast_beacon" exec="beacon"/>

  <node pkg="rosbridge_server" exec="rosbridge_websocket" />

  <node unless="$(var simulation)" pkg="urg_node" exec="urg_node_driver" name="lidar0_node">
    <param name="serial_port" value="/dev/ttyACM0" />
    <param name="laser_frame_id" value="lidar0_link" />
    <remap from="scan" to="scan0" />
  </node>

  <node unless="$(var simulation)" pkg="ldlidar" exec="ldlidar" name="lidar1_node">
    <param name="serial_port_candidates" value="[/dev/serial/by-path/pci-0000:00:14.0-usb-0:2.1:1.0-port0]" />
    <param name="lidar_frame" value="lidar1_link" />
    <remap from="scan" to="scan1" />
  </node>

  <node unless="$(var simulation)" pkg="ldlidar" exec="ldlidar" name="lidar2_node">
    <param name="serial_port_candidates" value="[/dev/serial/by-path/pci-0000:00:14.0-usb-0:2.2:1.0-port0]" />
    <param name="lidar_frame" value="lidar2_link" />
    <remap from="scan" to="scan2" />
  </node>

</launch>